# ITER-20260223-02

## Objetivo y contexto
Reducir riesgo de seguridad publicado en el repositorio Titanic SageMaker antes de continuar con fases de despliegue, aplicando hardening en codigo de evaluacion, permisos IAM de pipeline y supply-chain de GitHub Actions.

## Decisiones tecnicas y alternativas descartadas
1. Se corrigio extraccion de `tar.gz` en `pipeline/code/evaluate.py` para bloquear path traversal y enlaces simbolicos/hardlinks.
2. Se recorto la policy IAM del role de pipeline para eliminar acciones destructivas no requeridas en fase 03 (`DeleteEndpoint`, `DeleteEndpointConfig`, `DeleteModel`).
3. Se fijaron acciones de GitHub Actions por SHA en lugar de tags movibles para reducir riesgo de supply-chain.
4. Alternativa descartada: mantener configuracion actual con recomendacion documental sin mitigacion tecnica inmediata.

## IAM usado (roles/policies/permisos clave)
1. No se ejecutaron cambios IAM directos en AWS en esta iteracion.
2. Se actualizo IaC en `terraform/03_sagemaker_pipeline/iam.tf` para endurecer permisos del role de ejecucion del pipeline.

## Comandos ejecutados y resultado esperado
1. Validacion Python:
```bash
python3 -m py_compile pipeline/code/evaluate.py
```
Esperado: sin errores de sintaxis.

2. Validacion Terraform fase 03:
```bash
terraform -chdir=terraform/03_sagemaker_pipeline validate
```
Esperado: configuracion valida.

3. Escaneo rapido de secretos:
```bash
rg -n --hidden -g '!.git' '(AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}|-----BEGIN [A-Z ]*PRIVATE KEY-----|github_pat_|ghp_)' .
git log --all -p --no-color | rg -n '(AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}|-----BEGIN [A-Z ]*PRIVATE KEY-----|github_pat_|ghp_)'
```
Esperado: sin coincidencias de credenciales reales.

4. Publicacion de mitigaciones:
```bash
git commit -m "security: harden eval extraction, IAM scope, and CI action pinning"
git push origin main
```
Esperado: commit publicado en `main`.

## Evidencia
1. Commit de mitigacion:
   - `a51d8ca security: harden eval extraction, IAM scope, and CI action pinning`
2. Push remoto exitoso:
   - `0d797cf..a51d8ca  main -> main`
3. Endurecimiento aplicado:
   - `pipeline/code/evaluate.py`: `safe_extract_tar(...)` + bloqueo de symlink/hardlink/path traversal.
   - `terraform/03_sagemaker_pipeline/iam.tf`: removidas acciones `sagemaker:Delete*` de runtime.
   - `.github/workflows/tutorial-resource-activity-check.yml`: acciones fijadas por SHA.

## Riesgos/pendientes
1. Persisten riesgos residuales de configuracion runtime fuera del repositorio (por ejemplo SCPs, KMS, CloudTrail, configuracion IAM efectiva en cuenta).
2. Recomendado agregar escaneo de seguridad automatizado en CI (gitleaks/trivy/checkov/tfsec) con gate de merge.

## Proximo paso
1. Integrar scanner de secretos y IaC security checks en workflow de PR.
2. Revisar policies IAM de `docs/aws/policies/` para minimizar `Resource: "*"` donde sea tecnicamente viable.
3. Ejecutar revisiones periodicas de seguridad por iteracion y registrar evidencia en `docs/iterations/`.
