# ITER-20260220-04

## Objetivo y contexto
Registrar incidencia operativa durante el teardown de infraestructura Terraform del proyecto Titanic SageMaker, ejecutado con identidad `data-science-user`.

Scope de la iteracion:
1. Intentar `terraform destroy` en `terraform/03_sagemaker_pipeline`.
2. Intentar `terraform destroy` en `terraform/00_foundations`.
3. Documentar bloqueo de permisos y estado residual en AWS/Terraform state.

## Decisiones tecnicas y alternativas descartadas
1. Se ejecuto orden de destruccion por dependencia logica:
   - primero `03_sagemaker_pipeline`,
   - luego `00_foundations`.
2. Se mantuvo perfil operativo unico `data-science-user` (sin usar root ni otros usuarios).
3. Se aplico correccion puntual permitida por permisos actuales:
   - borrado manual del role IAM `titanic-sagemaker-pipeline-dev` via AWS CLI.
4. Alternativas descartadas:
   - forzar cambios en state sin evidencia operacional,
   - usar identidades no permitidas por contrato de proyecto.

## IAM usado (roles/policies/permisos clave)
1. Identidad humana operativa:
   - `arn:aws:iam::939122281183:user/data-science-user`
2. Perfil AWS CLI:
   - `data-science-user`
3. Permisos faltantes detectados durante el incidente:
   - `sagemaker:DeleteModelPackage`
   - `s3:DeleteBucketPolicy`
   - `iam:ListInstanceProfilesForRole` (durante delete de role en Terraform)
   - `s3:ListBucketVersions` (observado al inspeccionar versiones del bucket)

## Comandos ejecutados y resultado esperado
1. Destruccion fase 03:
```bash
AWS_PROFILE=data-science-user terraform -chdir=terraform/03_sagemaker_pipeline destroy -auto-approve \
  -var='data_bucket_name=titanic-data-bucket-939122281183-data-science-user' \
  -var='code_bundle_uri=s3://titanic-data-bucket-939122281183-data-science-user/pipeline/code/placeholder/pipeline_code.tar.gz'
```
Esperado: eliminar pipeline, model package group, role y policy.

2. Destruccion fase 00:
```bash
AWS_PROFILE=data-science-user terraform -chdir=terraform/00_foundations destroy -auto-approve
```
Esperado: eliminar bucket y controles asociados.

3. Correccion aplicada (manual):
```bash
AWS_PROFILE=data-science-user aws iam delete-role --role-name titanic-sagemaker-pipeline-dev
```
Esperado: eliminar role residual bloqueado por Terraform.

4. Verificacion de estado residual en Terraform state:
```bash
AWS_PROFILE=data-science-user terraform -chdir=terraform/03_sagemaker_pipeline state list
AWS_PROFILE=data-science-user terraform -chdir=terraform/00_foundations state list
```
Esperado: identificar recursos pendientes tras fallo parcial.

5. Verificacion de recursos activos globales:
```bash
AWS_PROFILE=data-science-user scripts/check_tutorial_resources_active.sh --phase all
```
Esperado: snapshot post-teardown de activos/inactivos/unknown.

## Evidencia
### Incidente reportado
1. Causa raiz:
   - El teardown quedo parcial por permisos IAM insuficientes para operaciones de borrado especificas.

2. Evidencia tecnica:
   - Error SageMaker:
     - `ValidationException: Model Package Group ... cannot be deleted because it still contains Model Packages.`
   - Error IAM:
     - `AccessDenied ... iam:ListInstanceProfilesForRole` durante delete del role desde Terraform.
   - Error SageMaker API:
     - `AccessDeniedException ... sagemaker:DeleteModelPackage` al intentar borrar `model-package/.../1`.
   - Error S3:
     - `AccessDenied ... s3:DeleteBucketPolicy` durante destroy de foundations.

3. Correccion aplicada:
   - Se elimino manualmente el role IAM residual (`titanic-sagemaker-pipeline-dev`).

4. Estado residual confirmado:
   - `terraform/03_sagemaker_pipeline` state:
     - `aws_sagemaker_model_package_group.this`
   - `terraform/00_foundations` state:
     - `aws_s3_bucket.tutorial_data[0]`
     - `aws_s3_bucket_policy.tutorial_data[0]`
   - `aws iam get-role --role-name titanic-sagemaker-pipeline-dev`:
     - `NoSuchEntity` (role ya eliminado)

5. Snapshot operativo post-incidente (`check_tutorial_resources_active.sh --phase all`):
   - `active=5`, `inactive=9`, `unknown=1`
   - Activos principales:
     - S3 bucket y prefijos `raw/`, `curated/`, `evaluation/`
     - modelo SageMaker `titanic-xgb-model-19022026`

6. Control preventivo propuesto:
   - Definir policy minima de teardown para `data-science-user` con:
     - `sagemaker:DeleteModelPackage`
     - `sagemaker:DeleteModelPackageGroup`
     - `s3:DeleteBucketPolicy`
     - `s3:ListBucketVersions`
     - `s3:DeleteObjectVersion`
     - `iam:ListInstanceProfilesForRole`
   - Ejecutar pre-check de permisos antes de `terraform destroy`.

## Riesgos/pendientes
1. El `ModelPackageGroup` no puede eliminarse hasta borrar versiones de model package.
2. El bucket de foundations mantiene policy y objetos; no se puede eliminar sin permisos adicionales y limpieza de versiones.
3. Existe drift operativo temporal entre recursos reales y objetivo de teardown completo.

## Proximo paso
1. Solicitar ajuste IAM para teardown seguro con `data-science-user`.
2. Eliminar `ModelPackage` residual y luego `ModelPackageGroup`.
3. Eliminar bucket policy + versiones de objetos y completar `terraform destroy` de foundations.
4. Re-ejecutar `scripts/check_tutorial_resources_active.sh --phase all` y adjuntar evidencia de estado final en una nueva iteracion.
